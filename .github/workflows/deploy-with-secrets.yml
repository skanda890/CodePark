name: Deploy with Secrets Management

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3

      # Load staging secrets from GitHub Secrets
      - name: Create .env.staging from secrets
        run: |
          cat > .env.staging << EOF
          NODE_ENV=staging
          PORT=3000
          HOST=0.0.0.0
          
          # Logging
          LOG_LEVEL=info
          LOG_HTTP_ENDPOINT=https://logs-staging.example.com/api/logs
          LOG_HTTP_API_KEY=${{ secrets.STAGING_LOG_API_KEY }}
          
          # CORS
          CORS_ORIGINS=https://staging.example.com,https://app-staging.example.com
          
          # Database (injected from secrets)
          MONGODB_URI=${{ secrets.STAGING_MONGODB_URI }}
          
          # Redis (injected from secrets)
          REDIS_HOST=redis-staging.example.com
          REDIS_PASSWORD=${{ secrets.STAGING_REDIS_PASSWORD }}
          
          # IP Whitelist
          IP_WHITELIST_MODE=whitelist
          IP_WHITELIST=10.0.0.0/8,192.168.0.0/16
          MAX_REQUESTS_PER_IP=5000
          
          # Caching
          CACHE_TTL=300000
          CACHE_MAX_SIZE=10000
          CACHE_BACKEND=memory
          
          # Feature Flags
          FEATURE_RATE_LIMITING=true
          FEATURE_CACHING=true
          FEATURE_COMPRESSION=true
          FEATURE_HEALTH_CHECKS=true
          
          # API Keys
          API_KEY_STAGING=${{ secrets.STAGING_API_KEY }}
          EOF

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:staging

      - name: Deploy to staging
        run: npm run deploy:staging
        env:
          STAGING_SERVER_IP: ${{ secrets.STAGING_SERVER_IP }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_SSH_USER: ${{ secrets.STAGING_SSH_USER }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      # CRITICAL: Load production secrets from GitHub Secrets
      # These are marked as sensitive and won't be printed in logs
      - name: Create .env.production from secrets
        run: |
          cat > .env.production << 'EOF'
          NODE_ENV=production
          PORT=3000
          HOST=0.0.0.0
          
          # Logging
          LOG_LEVEL=warn
          LOG_FILE=/var/log/codepark/app.log
          LOG_FILE_MAX_SIZE=52428800
          LOG_FILE_MAX_FILES=30
          LOG_HTTP_ENDPOINT=https://logs.example.com/api/logs
          LOG_HTTP_API_KEY=${{ secrets.PROD_LOG_API_KEY }}
          
          # CORS
          CORS_ORIGINS=https://example.com,https://www.example.com,https://api.example.com
          
          # Database (production - injected from secrets)
          MONGODB_URI=${{ secrets.PROD_MONGODB_URI }}
          
          # Redis (production - injected from secrets)
          REDIS_HOST=redis-prod.example.com
          REDIS_PORT=6380
          REDIS_PASSWORD=${{ secrets.PROD_REDIS_PASSWORD }}
          REDIS_TLS=true
          
          # IP Whitelist
          IP_WHITELIST_MODE=whitelist
          IP_WHITELIST=10.0.0.0/8
          MAX_REQUESTS_PER_IP=1000
          
          # Caching
          CACHE_TTL=600000
          CACHE_MAX_SIZE=50000
          CACHE_BACKEND=redis
          
          # Compression
          COMPRESSION_LEVEL=9
          COMPRESSION_MIN_SIZE=512
          
          # Feature Flags
          FEATURE_RATE_LIMITING=true
          FEATURE_CACHING=true
          FEATURE_COMPRESSION=true
          FEATURE_HEALTH_CHECKS=true
          
          # Security
          SECURE_COOKIES=true
          HSTSMaxAge=31536000
          HSTSIncludeSubDomains=true
          
          # API Keys
          API_KEY_PRODUCTION=${{ secrets.PROD_API_KEY }}
          
          # Monitoring
          METRICS_ENDPOINT=https://prometheus.example.com/push
          ALERT_EMAIL=alerts@example.com
          
          # No debug in production
          DEBUG=
          EOF

      - name: Verify no secrets in logs
        run: |
          # Additional safety check - ensure secrets aren't in any files
          if grep -r "mongodb+srv://" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "ERROR: Hardcoded MongoDB URI found"
            exit 1
          fi
          if grep -r "redis_password\|redisPassword" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "ERROR: Hardcoded Redis password found"
            exit 1
          fi
          echo "✓ No hardcoded secrets detected"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:integration

      - name: Build Docker image
        run: |
          docker build \
            -f Dockerfile.prod \
            -t ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ github.repository }}:latest \
            .

      - name: Deploy to production
        run: npm run deploy:prod
        env:
          PROD_SERVER_IP: ${{ secrets.PROD_SERVER_IP }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_SSH_USER: ${{ secrets.PROD_SSH_USER }}
          DOCKER_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify deployment
        if: success()
        run: |
          echo "✓ Production deployment successful"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date)"

      - name: Alert on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "❌ CodePark production deployment failed",
              "attachments": [{
                "color": "danger",
                "fields": [
                  {"title": "Commit", "value": "${{ github.sha }}"},
                  {"title": "Branch", "value": "${{ github.ref }}"},
                  {"title": "Author", "value": "${{ github.actor }}"}
                ]
              }]
            }'

  # Security scanning job
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for secrets scanning

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Check for common secret patterns
        run: |
          set +e  # Don't exit on grep
          
          echo "Checking for hardcoded secrets..."
          
          # Check for MongoDB URI patterns
          if grep -r "mongodb+srv://.*:.*@" . --exclude-dir=.git --exclude-dir=node_modules --exclude=*.md; then
            echo "❌ FAIL: Hardcoded MongoDB credentials found"
            exit 1
          fi
          
          # Check for API key patterns
          if grep -r "sk_[a-z]*_[A-Za-z0-9]\{20,\}" . --exclude-dir=.git --exclude-dir=node_modules --exclude=*.md; then
            echo "❌ FAIL: Potential API keys found"
            exit 1
          fi
          
          # Check for password= patterns
          if grep -r 'password["\x27]*\s*[:=]' . --exclude-dir=.git --exclude-dir=node_modules --exclude=.env.example --exclude=*.md; then
            echo "⚠️  WARNING: Password assignment found (verify it's not hardcoded)"
          fi
          
          echo "✓ Security scan passed"

# ============================================================================
# REQUIRED GITHUB SECRETS (Set in: Settings → Secrets and Variables → Actions)
# ============================================================================
#
# Staging Secrets:
#   - STAGING_MONGODB_URI: mongodb+srv://username:password@cluster.mongodb.net/db
#   - STAGING_REDIS_PASSWORD: your-redis-password
#   - STAGING_LOG_API_KEY: your-log-api-key
#   - STAGING_API_KEY: sk_staging_xxxx
#   - STAGING_SERVER_IP: x.x.x.x
#   - STAGING_SSH_KEY: (private SSH key)
#   - STAGING_SSH_USER: deploy-user
#
# Production Secrets:
#   - PROD_MONGODB_URI: mongodb+srv://username:password@prod-cluster.mongodb.net/db
#   - PROD_REDIS_PASSWORD: your-production-redis-password
#   - PROD_LOG_API_KEY: your-production-log-api-key
#   - PROD_API_KEY: sk_prod_xxxx
#   - PROD_SERVER_IP: x.x.x.x
#   - PROD_SSH_KEY: (private SSH key for production)
#   - PROD_SSH_USER: deploy-user
#   - SLACK_WEBHOOK: https://hooks.slack.com/services/... (for notifications)
#
# ============================================================================
